# redirect all http traffic to https
server {
    server_name ~^(?<subdomain>.+)<%= "\.#{@domain}" %>$;
    listen 80 default_server;

    # block pingdom
    if ($http_user_agent ~* Pingdom.com_bot) {
        return 403;
    }

    location / {
        return 301 https://$subdomain.<%= @domain %>$request_uri;
    }

    location /basic_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}

server {
    server_name <%= "#{@hostname}.#{@domain}" %>;

    listen 443 ssl default_server;

    root <%= "/var/www/#{node['application']}/public" %>;

    rewrite ^(.+)/+$ $1 permanent;

    location = /status {
        default_type text/html;
        echo "OK";
    }

    location / {
      return 301 https://$host/status;
    }

    location /basic_status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}

server {
  server_name <%= "#{@application}.#{node['domain']}" %>;

  listen 80 default_server;
  listen 443 default_server;
  <% if node['ruby']['enable_capistrano'] %>
    root <%= "/var/www/#{@application}/current/public" %>;
  <% else %>
    root <%= "/var/www/#{@application}/public" %>;
  <% end %>
  passenger_enabled on;
  passenger_app_env <%= @rails_env %>;
  <% if node['ruby']['merge_slashes_off'] %>
  merge_slashes off;
  <% end %>
  <% if node['ruby']['api_only'] %>
    location / {
      try_files $uri;
    }

    location /api {
      passenger_enabled on;
    }
  <% end %>
  location ~* .(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 365d;
  }
}

server {
    server_name <%= "#{@fqdn}" %>;

    ssl_ciphers 'ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256$
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.1 TLSv1;
    ssl_certificate /etc/nginx/ssl/<%= "#{@domain}" %>.crt;
    ssl_certificate_key /etc/nginx/ssl/<%= "#{@domain}" %>.key;
    ssl_dhparam /etc/nginx/ssl/dhparams.pem;

    listen 80 default_server;
    listen 443 ssl default_server;
}

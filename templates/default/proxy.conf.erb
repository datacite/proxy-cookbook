<% if node['proxy']['always_use_ssl'] %>
server {
    server_name <%= "#{@hostname}.#{@domain}" %>;
    listen 80;
    return 301 https://$host/status;
}
<% end %>

server {
    server_name <%= "#{@hostname}.#{@domain}" %>;

    ssl_certificate <%= "#{@ssl_cert}" %>;
    ssl_certificate_key <%= "#{@ssl_key}" %>;

    <% if !node['proxy']['always_use_ssl'] %>
    listen 80;
    <% end %>
    listen 443 ssl default_server;

    root <%= "/var/www/#{node['application']}/public" %>;

    rewrite ^(.+)/+$ $1 permanent;

    location = /status {
        alias <%= "/var/www/#{node['application']}/public" %>/status/index.html;
        autoindex off;
        default_type text/html;
    }
}

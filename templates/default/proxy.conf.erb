# redirect all http traffic to https
server {
    server_name ~^(?<subdomain>.+)<%= "\.#{@domain}" %>$;
    listen 80 default_server;
    return 301 https://$subdomain.<%= @domain %>$request_uri$is_args$args;
}

server {
    server_name <%= "#{@hostname}.#{@domain}" %>;

    listen 443 ssl default_server;

    root <%= "/var/www/#{node['application']}/public" %>;

    rewrite ^(.+)/+$ $1 permanent;

    location = /status {
        default_type text/html;
        echo "OK";
    }

    location / {
      return 301 https://$host/status;
    }
}
